[Rainmeter]
Update=1000
AccurateText=1
DynamicWindowSize=1
; ACTION: On startup -> Show Syncing -> Hide Main -> short delay so SYNCING shows -> Run Script
OnRefreshAction=[!ShowMeterGroup Syncing][!HideMeterGroup Main][!Redraw][!Delay 150][!CommandMeasure MeasureRunScript "Run"]

[Metadata]
Name=DSA Tracker
Author=Varun
Information=Duolingo-inspired Stats Tracker (Path Fix)
Version=2.9
License=Creative Commons Attribution-Non-Commercial-Share Alike 3.0

[Variables]
; --- CONFIGURATION (modular: no user-specific paths here) ---
; Default: use "pythonw" from PATH. To use a full path (e.g. to avoid App Installer popup),
; edit local.inc and uncomment/set PythonPath and PythonParam there.
PythonPath=pythonw
PythonParam=#CURRENTPATH#stats.py
@Include=#CURRENTPATH#local.inc

; --- Design Variables ---
Width=180
Height=235
CornerRadius=26
Center=90
BorderWidth=3

; --- Colors ---
ColorBg=20,20,20,240
ColorTextMain=255,255,255,255
ColorTextSub=150,150,150,255
ColorAccent=255,150,0,255
ColorSeparator=50,50,50,255

; --- Fonts ---
FontMain=Segoe UI
FontBold=Segoe UI Black

; Load variables (Silent load)
@Include=#CURRENTPATH#variables.inc

; ----------------------------------
; MEASURES
; ----------------------------------

; 1. The Script Runner (Uses Variable for Path)
[MeasureRunScript]
Measure=Plugin
Plugin=RunCommand
Program=#PythonPath#
Parameter=#PythonParam#
State=Hide
OutputType=ANSI
StartInFolder=#CURRENTPATH#
; TIMEOUT: 15s protection
Timeout=15000
TimeoutAction=[!HideMeterGroup Syncing][!ShowMeterGroup Main][!Redraw][!Log "DSA Tracker: Script Timed Out" Error]
; FINISH: Parse script stdout (avoids WebParser file cache), set variables, then show Main with new values.
FinishAction=[!UpdateMeasure MeasureParsedStreak][!UpdateMeasure MeasureParsedTotal][!UpdateMeasure MeasureParsedLC][!UpdateMeasure MeasureParsedGFG][!UpdateMeasure MeasureParsedFire][!SetVariable Streak "[MeasureParsedStreak]"][!SetVariable TotalSolved "[MeasureParsedTotal]"][!SetVariable LC_Count "[MeasureParsedLC]"][!SetVariable GFG_Count "[MeasureParsedGFG]"][!SetVariable FireImg "[MeasureParsedFire]"][!UpdateMeter *][!HideMeterGroup Syncing][!ShowMeterGroup Main][!Redraw]
UpdateDivider=-1

; 1b. Parse RunCommand stdout (script prints RAINMETER:Streak=N|TotalSolved=N|... so we get fresh values, no file cache)
;     Fallback (?s)^.{30,}$ = when script fails, replace any long/multi-line output with 0 so big text never shows
[MeasureParsedStreak]
Measure=String
String=[MeasureRunScript]
RegExpSubstitute=1
Substitute="(?s).*Streak=(\d+)\|.*":"\1","(?s)^.{30,}$":"0"
DynamicVariables=1
UpdateDivider=-1

[MeasureParsedTotal]
Measure=String
String=[MeasureRunScript]
RegExpSubstitute=1
Substitute="(?s).*TotalSolved=(\d+)\|.*":"\1","(?s)^.{30,}$":"0"
DynamicVariables=1
UpdateDivider=-1

[MeasureParsedLC]
Measure=String
String=[MeasureRunScript]
RegExpSubstitute=1
Substitute="(?s).*LC_Count=(\d+)\|.*":"\1","(?s)^.{30,}$":"0"
DynamicVariables=1
UpdateDivider=-1

[MeasureParsedGFG]
Measure=String
String=[MeasureRunScript]
RegExpSubstitute=1
Substitute="(?s).*GFG_Count=(\d+)\|.*":"\1","(?s)^.{30,}$":"0"
DynamicVariables=1
UpdateDivider=-1

[MeasureParsedFire]
Measure=String
String=[MeasureRunScript]
RegExpSubstitute=1
Substitute="(?s).*FireImg=([^\|\r\n]+).*":"\1","(?s)^.{30,}$":"fireoff.png"
DynamicVariables=1
UpdateDivider=-1

; 2. The Silent Parser (reads variables.inc at load / on refresh; left-click update uses parsed stdout above)
[MeasureParser]
Measure=WebParser
URL=file://#CURRENTPATH#variables.inc
RegExp=(?siU)Streak=(.*)\s+TotalSolved=(.*)\s+LC_Count=(.*)\s+GFG_Count=(.*)\s+FireImg=(.*)\s+
; When parser finishes: set variables, update meters, THEN hide Syncing and show Main (so user sees new values)
FinishAction=[!SetVariable Streak "[MeasureStreak]"][!SetVariable TotalSolved "[MeasureTotalSolved]"][!SetVariable LC_Count "[MeasureLCCount]"][!SetVariable GFG_Count "[MeasureGFGCount]"][!SetVariable FireImg "[MeasureFireImg]"][!UpdateMeter *][!HideMeterGroup Syncing][!ShowMeterGroup Main][!Redraw]
UpdateDivider=-1

[MeasureStreak]
Measure=WebParser
URL=[MeasureParser]
StringIndex=1

[MeasureTotalSolved]
Measure=WebParser
URL=[MeasureParser]
StringIndex=2

[MeasureLCCount]
Measure=WebParser
URL=[MeasureParser]
StringIndex=3

[MeasureGFGCount]
Measure=WebParser
URL=[MeasureParser]
StringIndex=4

[MeasureFireImg]
Measure=WebParser
URL=[MeasureParser]
StringIndex=5

; 3. Auto-Update Timer (Every 10 mins)
[MeasureTimer]
Measure=Calc
Formula=(MeasureTimer % 600) + 1
IfEqualValue=600
; ACTION: Show Syncing -> Run Script
IfEqualAction=[!ShowMeterGroup Syncing][!HideMeterGroup Main][!Redraw][!CommandMeasure MeasureRunScript "Run"]

; ----------------------------------
; STYLES
; ----------------------------------

[StyleTextCenter]
StringAlign=Center
AntiAlias=1

; ----------------------------------
; METERS
; ----------------------------------

; --- Background (Always Visible) ---
[MeterBackground]
Meter=Shape
Shape=Rectangle (#BorderWidth#/2),(#BorderWidth#/2),(#Width#-#BorderWidth#),(#Height#-#BorderWidth#),#CornerRadius# | Fill Color #ColorBg# | StrokeWidth #BorderWidth# | Stroke Color #ColorAccent#

; =================================================
; GROUP: Main (Visible normally, Hidden when syncing)
; =================================================

; --- Streak ---
[MeterStreakIcon]
Meter=Image
Group=Main
ImageName=#CURRENTPATH##FireImg#
X=70
Y=15
W=40
H=40
PreserveAspectRatio=1
DynamicVariables=1

[MeterStreakText]
Meter=String
MeterStyle=StyleTextCenter
Group=Main
FontFace=#FontBold#
FontSize=14
FontColor=#ColorAccent#
X=#Center#
Y=0R
Text=#Streak# Day Streak
DynamicVariables=1

; --- Total Solved ---
[MeterTotalCount]
Meter=String
MeterStyle=StyleTextCenter
Group=Main
FontFace=#FontBold#
FontSize=48
FontColor=#ColorTextMain#
X=#Center#
Y=0R
Text=#TotalSolved#
DynamicVariables=1

[MeterTotalLabel]
Meter=String
MeterStyle=StyleTextCenter
Group=Main
FontFace=#FontMain#
FontSize=10
FontColor=#ColorTextSub#
X=#Center#
Y=-10R
Text=PROBLEMS SOLVED

; --- Platforms ---
[MeterSeparator]
Meter=Shape
Group=Main
Shape=Line 20,175,160,175 | StrokeWidth 2 | Stroke Color #ColorSeparator#

[MeterLCLabel]
Meter=String
MeterStyle=StyleTextCenter
Group=Main
FontFace=#FontMain#
FontSize=9
FontColor=#ColorAccent#
X=50
Y=185
Text=LEETCODE

[MeterLCValue]
Meter=String
MeterStyle=StyleTextCenter
Group=Main
FontFace=#FontBold#
FontSize=16
FontColor=#ColorTextMain#
X=50
Y=200
Text=#LC_Count#
DynamicVariables=1

[MeterGFGLabel]
Meter=String
MeterStyle=StyleTextCenter
Group=Main
FontFace=#FontMain#
FontSize=9
FontColor=#ColorAccent#
X=130
Y=185
Text=GFG

[MeterGFGValue]
Meter=String
MeterStyle=StyleTextCenter
Group=Main
FontFace=#FontBold#
FontSize=16
FontColor=#ColorTextMain#
X=130
Y=200
Text=#GFG_Count#
DynamicVariables=1

; =================================================
; GROUP: Syncing (Hidden normally, Visible when syncing)
; =================================================

[MeterSyncText]
Meter=String
MeterStyle=StyleTextCenter
Group=Syncing
Hidden=1
FontFace=#FontBold#
FontSize=12
FontColor=#ColorAccent#
X=#Center#
Y=(#Height#/2 - 10)
Text=SYNCING...

; --- Interaction ---
[MeterClickArea]
Meter=Image
SolidColor=0,0,0,1
X=0
Y=0
W=#Width#
H=#Height#
MouseActionCursor=1
; ACTION: On Left Click -> Show Syncing -> Hide Main -> short delay so SYNCING is visible -> Run Script
LeftMouseDownAction=[!ShowMeterGroup Syncing][!HideMeterGroup Main][!Redraw][!Delay 150][!CommandMeasure MeasureRunScript "Run"]
ToolTipText=Left-click to refresh stats